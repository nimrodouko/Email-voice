

<!DOCTYPE html>
<html>
	
<head>
	<meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet"  href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

	<title>Send Email</title>
</head>
{% block content%}
<body>

	<div class="containerfluid">
		<h1>SEND EMAIL</h1>
		<form id="audio-form" method="POST">
			<div class="form-group">
				<label for="to">To:</label>
				<input type="email" class="form-control" id="to" name="to_email" placeholder="Enter email">
			</div>
			
			<div class="form-group">
				<label for="body"><button id="start-button">Record</button></label>
				<label for="body"><button id="stop-button">stop</button></label>
				<input type="hidden" id="audio-data" name="audio_data">
				
				<textarea class="form-control" rows="10" id="transcription-text" placeholder="Transcribed text" name="transcription"></textarea>
				
			</div>
			<button type="submit" id="send-button">Send</button>
		</form>
		</div>
</body>
{% endblock content%}
<script>
	const startButton = document.querySelector('#start-button');
const stopButton = document.querySelector('#stop-button');
let mediaRecorder;
let audioChunks = [];

navigator.mediaDevices.getUserMedia({ audio: true })
  .then(function(stream) {
    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.addEventListener("dataavailable", function(event) {
      audioChunks.push(event.data);
    });
  });

startButton.addEventListener('click', function() {
  audioChunks = [];
  mediaRecorder.start();
});

stopButton.addEventListener('click', function() {
  mediaRecorder.stop();
});
const audioForm = document.querySelector('#audio-form');
const audioDataInput = document.querySelector('#audio-data');

audioForm.addEventListener('submit', function(event) {
  event.preventDefault();
  const formData = new FormData(audioForm);
  formData.set('audio_data', new Blob(audioChunks, { type: 'audio/webm' }));
  fetch('/transcribe-audio/', {
    method: 'POST',
    body: formData,
  }).then(function(response) {
    return response.json();
  }).then(function(data) {
    const transcriptionText = document.querySelector('#transcription-text');
    transcriptionText.value = data.transcription;
  });
});

const sendButton = document.querySelector('#send-button');

sendButton.addEventListener('click', function() {
  const toEmailInput = document.querySelector('#to');
  const contentInput = document.querySelector('#transcription-text');
  const formData = new FormData();
  formData.set('to_email', toEmailInput.value);
  formData.set('transcription', contentInput.value);
  fetch('/send-email/', {
    method: 'POST',
    body: formData,
  }).then(function(response) {
    return response.json();
  }).then(function(data) {
    console.log(data);
  });
});



</script>
</html>




