

<!DOCTYPE html>
<html>
	
<head>
	<meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet"  href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

	<title>Send Email</title>
</head>
{% block content%}
<body>

	<div class="containerfluid">
		<h1>SEND EMAIL</h1>
		<form id="audio-form" method="POST">
			<div class="form-group">
				<label for="to">To:</label>
				<input type="email" class="form-control" id="to" name="to_email" placeholder="Enter email">
			</div>
			
			<div class="form-group">
				<label for="body"><button id="start-button">Record</button></label>
				<input type="hidden" id="audio-data" name="audio_data">
				<textarea class="form-control" rows="10" id="email-body" placeholder="Enter email body"name="content"></textarea>
				<textarea class="form-control" rows="10" id="transcription-text" placeholder="Transcribed text" name="transcription"></textarea>
				
			</div>
		
		
			
			
			
				
			<button type="submit">Send</button>
		</form>
		<div id="transcription"></div>
	

	</div>
	
	


	

	<script>
		var startButton = document.getElementById('start-button');

		// get the audio stream from the microphone when the start button is clicked
		startButton.addEventListener('click', function() {
			navigator.mediaDevices.getUserMedia({ audio: true })
			.then(function(stream) {
				// create a new MediaRecorder object
				var mediaRecorder = new MediaRecorder(stream);

				// create an empty buffer to store the audio data
				var chunks = [];

				// add event listeners to handle the dataavailable and stop events
				mediaRecorder.addEventListener('dataavailable', function(event) {
					chunks.push(event.data);
				});

				mediaRecorder.addEventListener('stop', function() {
					// combine all the audio data into a single Blob object
					var audioBlob = new Blob(chunks, { type: 'audio/wav' });

					// convert the audio data to base64 string
					var reader = new FileReader();
					reader.readAsDataURL(audioBlob);
					reader.onloadend = function() {
						var base64data = reader.result.split(',')[1];

						// set the base64 string as the value of the hidden input field
						document.getElementById('audio-data').value = base64data;

						// submit the form
						document.getElementById('audio-form').submit();
					}
				});

				// start recording
				mediaRecorder.start();

				// stop recording after 2 minutes
				setTimeout(function() {
					mediaRecorder.stop();
					startButton.disabled = false;
				}, 120000); // 2 minutes in milliseconds
			})
			.catch(function(error) {
				console.log(error);
			});

			startButton.disabled = true;
		});

		//transcribe
		
    var audioForm = document.getElementById('audio-form');
    audioForm.addEventListener('submit', function(event) {
        event.preventDefault();
        var audioData = document.getElementById('audio-data').value;
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/transcribe-audio/');
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onload = function() {
            if (xhr.status === 200) {
                var data = JSON.parse(xhr.responseText);
                var transcription = data['transcription'];
                document.getElementById('email-body').value = transcription;
            } else {
                console.log('Request failed.  Returned status of ' + xhr.status);
            }
        };
        xhr.send(JSON.stringify({ audio_data: audioData }));
    });



	</script>
</body>
{% endblock content%}
</html>




